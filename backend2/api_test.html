<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agentic Commerce – API Test</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; min-height: 100vh; background: #0f172a; color: #e2e8f0; }
    .header { padding: 12px 20px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
    .header h1 { margin: 0; font-size: 1.25rem; color: #38bdf8; }
    .header .session-id { font-size: 11px; color: #94a3b8; max-width: 280px; overflow: hidden; text-overflow: ellipsis; }
    .header .status { font-size: 12px; color: #a5f3fc; }
    .header button { background: #334155; color: #e2e8f0; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; }
    .header button:hover { background: #475569; }
    .header button.primary { background: #0ea5e9; color: #fff; }
    .header button.primary:hover { background: #0284c7; }

    .start-screen { padding: 40px 20px; text-align: center; }
    .start-screen.hidden { display: none; }
    .start-screen .card { background: #1e293b; padding: 32px; border-radius: 16px; display: inline-block; text-align: center; max-width: 420px; }
    .start-screen h2 { margin: 0 0 12px 0; color: #38bdf8; }
    .start-screen p { margin: 0 0 24px 0; color: #94a3b8; font-size: 14px; }
    .start-screen button { background: #0ea5e9; color: #fff; border: none; padding: 12px 24px; border-radius: 10px; font-size: 16px; cursor: pointer; }
    .start-screen button:hover { background: #0284c7; }

    .main { display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; padding: 20px; }
    .main.hidden { display: none; }

    .panel { background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #334155; }
    .panel h3 { margin: 0 0 12px 0; font-size: 1rem; color: #38bdf8; }

    .messages { max-height: 280px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
    .msg { max-width: 90%; width: fit-content; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; }
    .msg.user { align-self: flex-end; background: #0ea5e9; color: #fff; }
    .msg.assistant { align-self: flex-start; background: #334155; }
    .msg .role { font-size: 10px; text-transform: uppercase; opacity: 0.8; margin-bottom: 4px; }

    .input-row { display: flex; gap: 8px; align-items: center; }
    .input-row input { flex: 1; background: #0f172a; border: 1px solid #334155; color: #e2e8f0; padding: 10px 14px; border-radius: 8px; font-size: 14px; }
    .input-row input:focus { outline: none; border-color: #0ea5e9; }
    .input-row button { background: #0ea5e9; color: #fff; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .input-row button:hover { background: #0284c7; }
    .input-row button:disabled { opacity: 0.5; cursor: not-allowed; }

    .search-results { display: grid; gap: 10px; }
    .product { background: #0f172a; padding: 12px; border-radius: 8px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .product .title { font-weight: 600; }
    .product .meta { font-size: 12px; color: #94a3b8; }
    .product button { background: #22c55e; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .product button:hover { background: #16a34a; }

    .cart-items { list-style: none; padding: 0; margin: 0; }
    .cart-items li { padding: 8px 0; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .cart-items li:last-child { border-bottom: none; }
    .cart-items button { background: #ef4444; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .why-first { font-size: 12px; color: #a5f3fc; margin-top: 12px; padding: 10px; background: #0f172a; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Agentic Commerce</h1>
    <span class="session-id" id="sessionIdLabel">—</span>
    <span class="status" id="statusLabel">—</span>
    <button type="button" id="btnNewSession">Neue Session</button>
  </div>

  <div class="start-screen" id="startScreen">
    <div class="card">
      <h2>Session starten</h2>
      <p>Starte eine neue Shopping-Session: Chat für den Brief, dann Suche über 3 Händler, Warenkorb und simulierter Checkout.</p>
      <button type="button" id="btnStart">Session starten</button>
    </div>
  </div>

  <div class="main hidden" id="mainWrap">
    <div class="panel">
      <h3>Chat – Brief erfassen</h3>
      <div class="messages" id="messages"></div>
      <div class="input-row">
        <input type="text" id="inputMsg" placeholder="z.B. Ski-Outfit, 400€, Größe M, in 5 Tagen..." autocomplete="off">
        <button type="button" id="btnSend">Senden</button>
      </div>
      <div id="searchRow" class="input-row" style="margin-top:12px; display:none;">
        <button type="button" id="btnSearch" class="primary">Suche starten (3 Händler + Ranking)</button>
      </div>
    </div>

    <div class="panel" id="resultsPanel" style="display:none;">
      <h3>Suchergebnisse (ranked)</h3>
      <p class="why-first" id="whyFirst"></p>
      <div class="search-results" id="searchResults"></div>
    </div>

    <div class="panel" id="cartPanel" style="display:none;">
      <h3>Warenkorb</h3>
      <ul class="cart-items" id="cartItems"></ul>
      <p id="cartTotal" style="margin:8px 0 0 0; font-size:14px;"></p>
      <button type="button" id="btnCheckout" style="margin-top:8px;">Checkout simulieren</button>
    </div>

    <div class="panel" id="checkoutPanel" style="display:none;">
      <h3>Checkout (Simulation)</h3>
      <p id="checkoutMessage"></p>
      <ul id="checkoutSteps"></ul>
    </div>
  </div>

  <script>
    const base = (window.location.protocol === 'http:' || window.location.protocol === 'https:')
      ? window.location.origin
      : 'http://127.0.0.1:8000';
    let sessionId = null;
    let sessionStatus = '';
    let lastSearchResult = null;
    let isSending = false;

    const startScreen = document.getElementById('startScreen');
    const mainWrap = document.getElementById('mainWrap');
    const messages = document.getElementById('messages');
    const inputMsg = document.getElementById('inputMsg');
    const btnSend = document.getElementById('btnSend');
    const btnStart = document.getElementById('btnStart');
    const btnNewSession = document.getElementById('btnNewSession');
    const sessionIdLabel = document.getElementById('sessionIdLabel');
    const statusLabel = document.getElementById('statusLabel');
    const searchRow = document.getElementById('searchRow');
    const btnSearch = document.getElementById('btnSearch');
    const resultsPanel = document.getElementById('resultsPanel');
    const whyFirst = document.getElementById('whyFirst');
    const searchResults = document.getElementById('searchResults');
    const cartPanel = document.getElementById('cartPanel');
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const btnCheckout = document.getElementById('btnCheckout');
    const checkoutPanel = document.getElementById('checkoutPanel');
    const checkoutMessage = document.getElementById('checkoutMessage');
    const checkoutSteps = document.getElementById('checkoutSteps');

    function showStart() {
      startScreen.classList.remove('hidden');
      mainWrap.classList.add('hidden');
      sessionId = null;
      sessionStatus = '';
      sessionIdLabel.textContent = '—';
      statusLabel.textContent = '—';
    }

    function showMain() {
      startScreen.classList.add('hidden');
      mainWrap.classList.remove('hidden');
      if (sessionId) sessionIdLabel.textContent = sessionId.substring(0, 8) + '…';
      statusLabel.textContent = sessionStatus || '—';
      if (sessionStatus === 'ready_for_search') searchRow.style.display = 'flex';
    }

    function addMessage(role, content) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.innerHTML = '<span class="role">' + (role === 'user' ? 'Du' : 'Agent') + '</span>' + content.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function createSession() {
      const r = await fetch(base + '/sessions', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      if (!r.ok) throw new Error('Session fehlgeschlagen');
      const data = await r.json();
      return data.session_id;
    }

    async function refreshSession() {
      if (!sessionId) return;
      const r = await fetch(base + '/sessions/' + encodeURIComponent(sessionId));
      if (!r.ok) return;
      const data = await r.json();
      sessionStatus = data.status;
      statusLabel.textContent = sessionStatus;
      if (sessionStatus === 'ready_for_search') searchRow.style.display = 'flex';
      const items = data.cart || data.items || [];
      if (items.length > 0) {
        cartPanel.style.display = 'block';
        renderCart(items, data);
      }
    }

    function renderCart(items, sessionData) {
      cartItems.innerHTML = '';
      let total = 0;
      items.forEach(i => {
        total += i.price * (i.quantity || 1);
        const li = document.createElement('li');
        li.innerHTML = '<span>' + (i.title || '').substring(0, 40) + ' – ' + i.price + ' ' + (i.currency || 'EUR') + '</span>' +
          '<button type="button" data-id="' + i.id + '">Entfernen</button>';
        li.querySelector('button').onclick = () => removeCartItem(i.id);
        cartItems.appendChild(li);
      });
      cartTotal.textContent = 'Gesamt: ' + total.toFixed(2) + ' EUR';
    }

    async function removeCartItem(itemId) {
      await fetch(base + '/sessions/' + encodeURIComponent(sessionId) + '/cart/items/' + itemId, { method: 'DELETE' });
      refreshSession();
    }

    async function sendChat(text) {
      const r = await fetch(base + '/sessions/' + encodeURIComponent(sessionId) + '/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.detail || 'Chat fehlgeschlagen');
      return data;
    }

    async function runSearch() {
      const r = await fetch(base + '/sessions/' + encodeURIComponent(sessionId) + '/search', { method: 'POST' });
      if (!r.ok) throw new Error('Suche fehlgeschlagen');
      return await r.json();
    }

    async function addToCart(product) {
      const body = {
        retailer_id: product.retailer_id,
        product_id: product.product_id,
        title: product.title,
        price: product.price,
        currency: product.currency || 'EUR',
        delivery_estimate_days: product.delivery_estimate_days,
        image_url: product.image_url,
        product_url: product.product_url,
        variants: product.variants || [],
        quantity: 1
      };
      const r = await fetch(base + '/sessions/' + encodeURIComponent(sessionId) + '/cart/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error('Hinzufügen fehlgeschlagen');
      refreshSession();
    }

    async function runCheckoutSimulation() {
      const r = await fetch(base + '/sessions/' + encodeURIComponent(sessionId) + '/checkout-simulation', { method: 'POST' });
      if (!r.ok) throw new Error('Checkout fehlgeschlagen');
      return await r.json();
    }

    async function startSession() {
      try {
        btnStart.disabled = true;
        sessionId = await createSession();
        sessionStatus = 'gathering_info';
        showMain();
        messages.innerHTML = '';
        addMessage('assistant', 'Hallo! Beschreibe, was du suchst – z.B. „Ski-Outfit, 400€, Größe M, in 5 Tagen“ oder „Super-Bowl-Party-Outfit, 150€“. Ich frage nach fehlenden Infos.');
      } catch (e) {
        alert('Fehler: ' + e.message + '. Backend unter ' + base + ' starten (uvicorn main:app --reload).');
      } finally {
        btnStart.disabled = false;
      }
    }

    async function onSend() {
      const text = inputMsg.value.trim();
      if (!text || !sessionId || isSending) return;
      inputMsg.value = '';
      addMessage('user', text);
      isSending = true;
      btnSend.disabled = true;
      try {
        const data = await sendChat(text);
        addMessage('assistant', data.reply || '');
        sessionStatus = data.status;
        statusLabel.textContent = sessionStatus;
        if (sessionStatus === 'ready_for_search') searchRow.style.display = 'flex';
      } catch (e) {
        addMessage('assistant', 'Fehler: ' + e.message);
      } finally {
        isSending = false;
        btnSend.disabled = false;
        messages.scrollTop = messages.scrollHeight;
      }
    }

    async function onSearch() {
      try {
        btnSearch.disabled = true;
        btnSearch.textContent = 'Suche läuft…';
        lastSearchResult = await runSearch();
        resultsPanel.style.display = 'block';
        whyFirst.textContent = 'Warum Platz 1: ' + (lastSearchResult.why_first || '');
        searchResults.innerHTML = '';
        (lastSearchResult.products || []).slice(0, 15).forEach(p => {
          const div = document.createElement('div');
          div.className = 'product';
          div.innerHTML = '<div><span class="title">' + (p.title || '').substring(0, 50) + '</span><br><span class="meta">' +
            (p.retailer_id || '') + ' · ' + p.price + ' ' + (p.currency || 'EUR') + ' · Score ' + (p.score != null ? p.score.toFixed(2) : '') + '</span></div>' +
            '<button type="button">In den Warenkorb</button>';
          div.querySelector('button').onclick = () => addToCart(p);
          searchResults.appendChild(div);
        });
        cartPanel.style.display = 'block';
        const cartR = await fetch(base + '/sessions/' + encodeURIComponent(sessionId) + '/cart');
        if (cartR.ok) {
          const cartData = await cartR.json();
          renderCart(cartData.items || [], cartData);
        }
      } catch (e) {
        alert('Suche fehlgeschlagen: ' + e.message);
      } finally {
        btnSearch.disabled = false;
        btnSearch.textContent = 'Suche starten (3 Händler + Ranking)';
      }
    }

    async function onCheckout() {
      try {
        const data = await runCheckoutSimulation();
        checkoutPanel.style.display = 'block';
        checkoutMessage.textContent = data.message || '';
        checkoutSteps.innerHTML = '';
        (data.steps || []).forEach(s => {
          const li = document.createElement('li');
          li.textContent = s.retailer_id + ': ' + s.description;
          checkoutSteps.appendChild(li);
        });
      } catch (e) {
        alert('Checkout: ' + e.message);
      }
    }

    btnStart.addEventListener('click', startSession);
    btnNewSession.addEventListener('click', showStart);
    btnSend.addEventListener('click', onSend);
    inputMsg.addEventListener('keydown', (e) => { if (e.key === 'Enter') onSend(); });
    btnSearch.addEventListener('click', onSearch);
    btnCheckout.addEventListener('click', onCheckout);
  </script>
</body>
</html>
