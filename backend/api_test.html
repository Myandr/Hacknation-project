<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hacknation – Chat testen</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; height: 100vh; background: #1a1a2e; color: #eee; display: flex; flex-direction: column; }
    .header { padding: 12px 20px; background: #16213e; border-bottom: 1px solid #0f3460; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { margin: 0; font-size: 1.25rem; color: #a8dadc; }
    .header .session-id { font-size: 11px; color: #94a3b8; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
    .header button { background: #0f3460; color: #a8dadc; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; }
    .header button:hover { background: #1a4a7a; }

    .start-screen { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .start-screen.hidden { display: none; }
    .start-screen .card { background: #16213e; padding: 32px; border-radius: 16px; text-align: center; max-width: 360px; }
    .start-screen h2 { margin: 0 0 12px 0; color: #a8dadc; font-size: 1.25rem; }
    .start-screen p { margin: 0 0 24px 0; color: #94a3b8; font-size: 14px; }
    .start-screen button { background: #e94560; color: #fff; border: none; padding: 12px 24px; border-radius: 10px; font-size: 16px; cursor: pointer; }
    .start-screen button:hover { background: #c73e54; }

    .chat-wrap { flex: 1; display: none; flex-direction: column; min-height: 0; }
    .chat-wrap.visible { display: flex; }

    .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .msg { max-width: 85%; width: fit-content; padding: 12px 16px; border-radius: 16px; font-size: 15px; line-height: 1.4; }
    .msg.user { align-self: flex-end; background: #e94560; color: #fff; border-bottom-right-radius: 4px; }
    .msg.assistant { align-self: flex-start; background: #16213e; border: 1px solid #0f3460; border-bottom-left-radius: 4px; }
    .msg .role { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 4px; }

    .typing { align-self: flex-start; padding: 12px 20px; background: #16213e; border-radius: 16px; border-bottom-left-radius: 4px; color: #94a3b8; font-size: 14px; }
    .typing::after { content: '...'; animation: dots 1s steps(4, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }

    .input-row { padding: 16px 20px; background: #16213e; border-top: 1px solid #0f3460; display: flex; gap: 10px; align-items: flex-end; }
    .input-row input { flex: 1; background: #0f3460; border: 1px solid #1a4a7a; color: #eee; padding: 12px 16px; border-radius: 24px; font-size: 15px; outline: none; }
    .input-row input::placeholder { color: #64748b; }
    .input-row input:focus { border-color: #e94560; }
    .input-row button { background: #e94560; color: #fff; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 18px; line-height: 1; flex-shrink: 0; }
    .input-row button:hover { background: #c73e54; }
    .input-row button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ShopBuddy Chat</h1>
    <span class="session-id" id="sessionIdLabel">—</span>
    <button type="button" id="btnNewChat">Neuer Chat</button>
  </div>

  <div class="start-screen" id="startScreen">
    <div class="card">
      <h2>Chat starten</h2>
      <p>Starte eine neue Session und beantworte die Fragen der KI (Budget, Präferenzen, Must-haves).</p>
      <p id="urlHint" style="display:none; font-size:12px; color:#e94560; margin-bottom:16px;">Öffne diese Seite im Browser unter: <strong>http://127.0.0.1:8000/api-test</strong> (nicht als lokale Datei).</p>
      <button type="button" id="btnStart">Neuen Chat starten</button>
    </div>
  </div>

  <div class="chat-wrap" id="chatWrap">
    <div class="messages" id="messages"></div>
    <div class="input-row">
      <input type="text" id="inputMsg" placeholder="Schreib deine Antwort..." autocomplete="off">
      <button type="button" id="btnSend" title="Senden">➤</button>
    </div>
  </div>

  <script>
    const base = (window.location.protocol === 'http:' || window.location.protocol === 'https:')
      ? window.location.origin
      : 'http://127.0.0.1:8000';
    let sessionId = null;
    let isSending = false;

    const startScreen = document.getElementById('startScreen');
    const chatWrap = document.getElementById('chatWrap');
    const messages = document.getElementById('messages');
    const inputMsg = document.getElementById('inputMsg');
    const btnSend = document.getElementById('btnSend');
    const btnStart = document.getElementById('btnStart');
    const btnNewChat = document.getElementById('btnNewChat');
    const sessionIdLabel = document.getElementById('sessionIdLabel');

    function showStart() {
      startScreen.classList.remove('hidden');
      chatWrap.classList.remove('visible');
      sessionId = null;
      sessionIdLabel.textContent = '—';
    }

    function showChat() {
      startScreen.classList.add('hidden');
      chatWrap.classList.add('visible');
      if (sessionId) sessionIdLabel.textContent = sessionId;
      inputMsg.focus();
    }

    function addMessage(role, content) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.innerHTML = '<span class="role">' + (role === 'user' ? 'Du' : 'ShopBuddy') + '</span>' + escapeHtml(content);
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function addTyping() {
      const div = document.createElement('div');
      div.className = 'typing';
      div.id = 'typing';
      div.textContent = 'Denkt nach';
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function removeTyping() {
      const el = document.getElementById('typing');
      if (el) el.remove();
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function createSession() {
      let r;
      try {
        r = await fetch(base + '/sessions', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      } catch (e) {
        throw new Error('Backend nicht erreichbar. Starte das Backend (uvicorn) und öffne diese Seite unter: ' + base + '/api-test');
      }
      let data;
      try {
        data = await r.json();
      } catch (_) {
        throw new Error('Ungültige Antwort vom Server (Status ' + r.status + '). Seite am besten unter ' + base + '/api-test öffnen.');
      }
      if (!r.ok) throw new Error(data.detail || 'Session fehlgeschlagen (Status ' + r.status + ')');
      return data.session_id;
    }

    async function sendChat(message) {
      const r = await fetch(base + '/sessions/' + encodeURIComponent(sessionId) + '/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.detail || 'Chat fehlgeschlagen');
      return data;
    }

    async function startNewChat() {
      try {
        btnStart.disabled = true;
        btnStart.textContent = 'Wird erstellt…';
        sessionId = await createSession();
        showChat();
        messages.innerHTML = '';
        addMessage('assistant', 'Hallo! Wofür brauchst du etwas? Erzähl mir z.B. den Anlass (Hochzeit, Geburtstag, …) und ob es um Kleidung, Essen oder beides geht.');
      } catch (e) {
        alert('Fehler: ' + e.message);
      } finally {
        btnStart.disabled = false;
        btnStart.textContent = 'Neuen Chat starten';
      }
    }

    async function sendMessage() {
      const text = inputMsg.value.trim();
      if (!text || !sessionId || isSending) return;
      inputMsg.value = '';
      addMessage('user', text);
      addTyping();
      isSending = true;
      btnSend.disabled = true;
      try {
        const data = await sendChat(text);
        removeTyping();
        addMessage('assistant', data.reply || '');
      } catch (e) {
        removeTyping();
        addMessage('assistant', 'Fehler: ' + e.message);
      } finally {
        isSending = false;
        btnSend.disabled = false;
        messages.scrollTop = messages.scrollHeight;
      }
    }

    if (window.location.protocol !== 'http:' && window.location.protocol !== 'https:') {
      document.getElementById('urlHint').style.display = 'block';
    }
    btnStart.addEventListener('click', startNewChat);
    btnNewChat.addEventListener('click', () => { showStart(); });
    btnSend.addEventListener('click', sendMessage);
    inputMsg.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
  </script>
</body>
</html>
